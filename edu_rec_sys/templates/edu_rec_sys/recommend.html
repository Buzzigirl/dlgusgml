<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI ê³¼ëª© ì¶”ì²œ ì‹œìŠ¤í…œ</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 2em; line-height: 1.6; background-color: #f9f9f9; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background-color: white; padding: 2em; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        table { border-collapse: collapse; width: 100%; margin: 1.5em 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: 600; }
        .form-container, .results-container, .student-info-container { margin-bottom: 2em; padding: 1.5em; border: 1px solid #e0e0e0; border-radius: 8px; }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5em 2em; }
        .filter-group { margin-top: 1.5em; }
        .filter-group strong { display: block; margin-bottom: 0.8em; font-size: 1.1em; border-bottom: 2px solid #007bff; padding-bottom: 0.3em; }
        
        .filter-options { display: flex; flex-wrap: wrap; gap: 10px; padding-top: 5px; }
        .filter-options label { cursor: pointer; user-select: none; display: inline-block; transition: transform 0.1s ease-out; }
        .filter-options label:active { transform: scale(0.95); }
        .filter-options span { display: inline-block; border: 1px solid #ccc; padding: 6px 12px; border-radius: 20px; background-color: #ffffff; color: #555; transition: all 0.2s ease-in-out; }
        .filter-options input[type="checkbox"] { display: none; }
        .filter-options input[type="checkbox"]:checked + span { background-color: #007bff; color: white; border-color: #007bff; font-weight: 500; }

        button { padding: 12px 20px; font-size: 1em; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #218838; }
        h1, h2, h3 { color: #0056b3; }
        .error { color: red; font-weight: bold; }
        select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; width: 100%; }

        .multi-select-dropdown { position: relative; width: 100%; }
        .select-display {
            width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px;
            background-color: white; cursor: pointer; user-select: none;
            display: flex; justify-content: space-between; align-items: center;
            box-sizing: border-box;
        }
        .select-display::after { content: 'â–¼'; font-size: 0.8em; }
        .checkbox-options {
            display: none; position: absolute; top: 100%; left: 0; right: 0;
            background-color: white; border: 1px solid #ccc; border-top: none;
            border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto;
            z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .checkbox-options.show { display: block; }
        .checkbox-options label {
            display: block; padding: 8px 12px; transition: background-color 0.2s;
            transform: none; 
        }
        .checkbox-options label:hover { background-color: #f0f0f0; }
        .checkbox-options input[type="checkbox"] { display: inline-block; margin-right: 8px; }
        .checkbox-options .select-all { font-weight: bold; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ Path-Finding AI ê³¼ëª© ì¶”ì²œ ì‹œìŠ¤í…œ</h1>

        <div class="form-container">
            <form method="post">
                {% csrf_token %}
                <label for="student_id"><strong>í•™ìƒ IDë¥¼ ì…ë ¥í•˜ê³  ì¶”ì²œ ê²°ê³¼ ë³´ê¸°:</strong></label><br>
                <input type="text" id="student_id" name="student_id" value="{{ student_id|default:'' }}" required style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-right: 10px;">
                <button type="submit">ëª¨ë¸ ì¶”ì²œ ë³´ê¸°</button>
                {% if error %}
                    <p class="error">{{ error }}</p>
                {% endif %}
            </form>
        </div>

        {% if student_data %}
        <div class="student-info-container">
            <h2>ğŸ“ í•™ìƒ ì •ë³´ (ID: {{ student_id }})</h2>
            <ul>
                <li><strong>ë‹¨ê³¼ëŒ€í•™:</strong> {{ student_data.info.student_college_name }}</li>
                <li><strong>ì£¼ì „ê³µ:</strong> {{ student_data.info.student_major_name }}</li>
                <li><strong>ì„¸ë¶€ì „ê³µ:</strong> {{ student_data.info.student_major_detail|default:"(ì •ë³´ ì—†ìŒ)" }}</li>
                <li><strong>ì…í•™ë…„ì›”:</strong> {{ student_data.info.ì…í•™ë…„ì›” }}</li>
            </ul>

            <h3>ğŸ“œ ì „ì²´ ìˆ˜ê°• ì´ë ¥</h3>
            {% for term, courses in student_data.history %}
                <p><strong>{{ term }}:</strong> {{ courses|join:", " }}</p>
            {% empty %}
                <p>ìˆ˜ê°• ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endfor %}
        </div>
        {% endif %}

        {% if base_recommendations %}
        <div class="results-container">
            <h2>1ï¸âƒ£ ëª¨ë¸ ì¶”ì²œ Top {{ base_recommendations|length }}ê°œ ê³¼ëª©</h2>
            <p> AI ëª¨ë¸ì´ ì˜ˆì¸¡í•œ 2024ë…„ 1í•™ê¸° ì¶”ì²œ ê³¼ëª©ì…ë‹ˆë‹¤.</p>
            
            <table style="margin-top: 0;">
                <thead>
                    <tr>
                        <th>ê³¼ëª©ëª…</th><th>ê³¼ëª© ë²ˆí˜¸</th><th>ê³¼ëª© ë¶„ë¥˜</th><th>ê³¼ëª© ì„¸ë¶€ë¶„ë¥˜</th><th>ì¶”ì²œ ì ìˆ˜</th>
                    </tr>
                </thead>
                <tbody>
                    {% for course in base_recommendations %}
                    <tr>
                        <td>{{ course.SUBJT_NM }}</td><td>{{ course.SUBJTNB }}</td><td>{{ course.subject_category }}</td><td>{{ course.subject_div }}</td><td>{{ course.pred_score|floatformat:3 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
             <hr style="margin: 2em 0;">

            <button id="show-filters-btn" onclick="showFilters()">âš™ï¸ ì»¤ìŠ¤í„°ë§ˆì´ì§• ì˜µì…˜ ì…ë ¥í•˜ê¸°</button>

            <div id="filter-section" style="display:none;">
                <h3>2ï¸âƒ£ ë‚˜ë§Œì˜ ë§ì¶¤ í•„í„° ì ìš©í•˜ê¸°</h3>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="student_id" value="{{ student_id }}">
                    <input type="hidden" name="is_filtering" value="true">
                    
                    <div class="filter-grid">
                        <div class="filter-group">
                            <strong>ê³¼ëª© ë¶„ë¥˜:</strong>
                            <div class="filter-options">
                                <label><input type="checkbox" name="subject_category" value="ì „ì²´" onchange="toggleFilters()"><span>ì „ì²´</span></label>
                                <label><input type="checkbox" name="subject_category" value="ì „ê³µ" onchange="toggleFilters()"><span>ì „ê³µ</span></label>
                                <label><input type="checkbox" name="subject_category" value="êµì–‘" onchange="toggleFilters()"><span>êµì–‘</span></label>
                                <label><input type="checkbox" name="subject_category" value="ê¸°íƒ€" onchange="toggleFilters()"><span>ê¸°íƒ€</span></label>
                            </div>
                        </div>

                        <div id="major-filters" style="display: none;">
                            <div class="filter-group">
                                <strong>ë‹¨ê³¼ëŒ€í•™ (ì „ê³µ):</strong>
                                <div class="multi-select-dropdown" id="college-dropdown">
                                    <div class="select-display">-- ì„ íƒ --</div>
                                    <div class="checkbox-options">
                                        <label class="select-all"><input type="checkbox" name="select_all">ì „ì²´ ì„ íƒ</label>
                                        {% for item in filter_options.college_name %}
                                        <label><input type="checkbox" name="college_name" value="{{ item }}"> {{ item }}</label>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div class="filter-group">
                                <strong>ì „ê³µ:</strong>
                                <div class="multi-select-dropdown" id="major-dropdown">
                                    <div class="select-display">-- ë‹¨ê³¼ëŒ€í•™ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš” --</div>
                                    <div class="checkbox-options">
                                        <label class="select-all"><input type="checkbox" name="select_all">ì „ì²´ ì„ íƒ</label>
                                    </div>
                                </div>
                            </div>
                            <div class="filter-group">
                                <strong>ì„¸ë¶€ì „ê³µ:</strong>
                                <div class="multi-select-dropdown" id="major-detail-dropdown">
                                    <div class="select-display">-- ì „ê³µì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš” --</div>
                                    <div class="checkbox-options">
                                        <label class="select-all"><input type="checkbox" name="select_all">ì „ì²´ ì„ íƒ</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="gyoyang-filters" style="display: none;">
                             <div class="filter-group">
                                <strong>êµì–‘ ë¶„ë¥˜:</strong>
                                <div class="multi-select-dropdown" id="gyoyang-type-dropdown">
                                    <div class="select-display">-- ì„ íƒ --</div>
                                    <div class="checkbox-options">
                                        <label class="select-all"><input type="checkbox" name="select_all">ì „ì²´ ì„ íƒ</label>
                                        {% for item in filter_options.general_type_gyoyang %}
                                        <label><input type="checkbox" name="general_type_gyoyang" value="{{ item }}">{{ item }}</label>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                             <div class="filter-group">
                                <strong>ì„¸ë¶€ êµì–‘ ë¶„ë¥˜:</strong>
                                <div class="multi-select-dropdown" id="gyoyang-subcategory-dropdown">
                                    <div class="select-display">-- êµì–‘ ë¶„ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš” --</div>
                                    <div class="checkbox-options">
                                        <label class="select-all"><input type="checkbox" name="select_all">ì „ì²´ ì„ íƒ</label>
                                        </div>
                                </div>
                            </div>
                             <div class="filter-group">
                                <strong>êµì–‘ ì´ìˆ˜ êµ¬ë¶„:</strong>
                                <div class="multi-select-dropdown">
                                    <div class="select-display">-- ì„ íƒ --</div>
                                    <div class="checkbox-options">
                                        <label class="select-all"><input type="checkbox" name="select_all">ì „ì²´ ì„ íƒ</label>
                                        {% for item in filter_options.general_term_gyoyang %}
                                        <label><input type="checkbox" name="general_term_gyoyang" value="{{ item }}">{{ item }}</label>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="etc-filters" style="display: none;">
                            <div class="filter-group">
                                <strong>ê¸°íƒ€ ë¶„ë¥˜:</strong>
                                <div class="multi-select-dropdown">
                                    <div class="select-display">-- ì„ íƒ --</div>
                                    <div class="checkbox-options">
                                        <label class="select-all"><input type="checkbox" name="select_all">ì „ì²´ ì„ íƒ</label>
                                        {% for item in filter_options.etc_type %}
                                        <label><input type="checkbox" name="etc_type" value="{{ item }}" {% if item in submitted_filters.etc_type %}checked{% endif %}>{{ item }}</label>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <strong>í•™ì  (ë³µìˆ˜ì„ íƒ ê°€ëŠ¥):</strong>
                            <div class="filter-options">
                            <label><span onclick="checkAllOptions('credit')">ì „ì²´</span></label> 
                            {% for c in filter_options.credit %}  
                                <label><input type="checkbox" name="credit" value="{{ c }}" {% if c|stringformat:"s" in submitted_filters.credit %}checked{% endif %}><span>{{ c }}í•™ì </span></label>
                            {% endfor %}
                            </div>
                        </div>

                        <div class="filter-group">
                            <strong>ì„ í˜¸ ìš”ì¼ (ë³µìˆ˜ì„ íƒ ê°€ëŠ¥):</strong>
                            <div class="filter-options">
                            <label><span onclick="checkAllOptions('preferred_days')">ì „ì²´</span></label>
                            {% for day in filter_options.days %}
                                <label><input type="checkbox" name="preferred_days" value="{{ day }}" {% if day in submitted_filters.preferred_days %}checked{% endif %}><span>{{ day }}</span></label>
                            {% endfor %}
                            </div>
                        </div>

                        <div class="filter-group">
                            <strong>ì„ í˜¸ êµì‹œ (ë³µìˆ˜ì„ íƒ ê°€ëŠ¥):</strong>
                            <div class="filter-options">
                            <label><span onclick="checkAllOptions('preferred_periods')">ì „ì²´</span></label>
                            {% for period in filter_options.periods %}
                                <label><input type="checkbox" name="preferred_periods" value="{{ period }}" {% if period|stringformat:"s" in submitted_filters.preferred_periods %}checked{% endif %}><span>{{ period }}êµì‹œ</span></label>
                            {% endfor %}
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <strong>ìˆ˜ì—… ë°©ì‹ (ë³µìˆ˜ì„ íƒ ê°€ëŠ¥):</strong>
                            <div class="filter-options">
                            <label><span onclick="checkAllOptions('class_styles')">ì „ì²´</span></label>                   
                            {% for item in filter_options.class_style %}
                                <label><input type="checkbox" name="class_styles" value="{{ item }}" {% if item in submitted_filters.class_styles %}checked{% endif %}><span>{{ item }}</span></label>
                            {% endfor %}
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <strong>í‰ê°€ ê¸°ì¤€ (ë³µìˆ˜ì„ íƒ ê°€ëŠ¥):</strong>
                            <div class="filter-options">
                            <label><span onclick="checkAllOptions('grade_evaluation')">ì „ì²´</span></label>                                
                                {% for item in filter_options.grade_evaluation %}
                                <label><input type="checkbox" name="grade_evaluation" value="{{ item }}" {% if item in submitted_filters.grade_evaluation %}checked{% endif %}><span>{{ item }}</span></label>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="filter-group">
                            <strong>ì„±ì  í‰ê°€ ë°©ì‹ (ë³µìˆ˜ì„ íƒ ê°€ëŠ¥):</strong>
                            <div class="filter-options">
                            <label><span onclick="checkAllOptions('grade_eval_methods')">ì „ì²´</span></label>
                            {% for item in filter_options.grade_eval_methods %}
                                <label><input type="checkbox" name="grade_eval_methods" value="{{ item }}" {% if item in submitted_filters.grade_eval_methods %}checked{% endif %}><span>{{ item }}</span></label>
                            {% endfor %}
                            </div>
                        </div>

                        <div class="filter-group">
                            <strong>ê°•ì˜ ë°©ì‹ (ë³µìˆ˜ì„ íƒ ê°€ëŠ¥):</strong>
                            <div class="filter-options">
                            <label><span onclick="checkAllOptions('lecture_methods')">ì „ì²´</span></label>
                            {% for item in filter_options.lecture_methods %}
                                <label><input type="checkbox" name="lecture_methods" value="{{ item }}" {% if item in submitted_filters.lecture_methods %}checked{% endif %}><span>{{ item }}</span></label>
                            {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" style="margin-top: 1em;">í•„í„° ì ìš©í•˜ê¸°</button>
                </form>
            </div>
            
            {% if filtered_recommendations is not None %}
            <div id="filtered-results">
                <hr style="margin: 2em 0;">
                <h3>âœ”ï¸ í•„í„° ì ìš© ê²°ê³¼ ({{ filtered_recommendations|length }}ê°œ)</h3>
                <table>
                    <thead>
                        <tr><th>ê³¼ëª©ëª…</th><th>í•™ì •ë²ˆí˜¸</th><th>ë¶„ë°˜</th><th>ê³¼ëª© ë¶„ë¥˜</th><th>ê³¼ëª© ì„¸ë¶€ë¶„ë¥˜</th><th>ê°œì„¤ ì‹œê°„</th><th>ì¶”ì²œ ì ìˆ˜</th></tr>
                    </thead>
                    <tbody>
                        {% for course in filtered_recommendations %}
                        <tr><td>{{ course.SUBJT_NM }}</td><td>{{ course.SUBJTNB }}</td><td>{{ course.CORSE_DVCLS_NO }}</td><td>{{ course.subject_category }}</td><td>{{ course.subject_div }}</td><td>{{ course.schedule_pairs }}</td><td>{{ course.pred_score|floatformat:3 }}</td></tr>
                        {% empty %}
                        <tr><td colspan="5">ì¡°ê±´ì— ë§ëŠ” ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤. í•„í„°ë¥¼ ì¡°ì •í•´ë³´ì„¸ìš”.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <script id="major-hierarchy-data" type="application/json">{{ major_hierarchy_json|safe }}</script>
    <script id="gyoyang-hierarchy-data" type="application/json">{{ gyoyang_hierarchy_json|safe }}</script>
    <script>
        // ìµœì¢… ì™„ì„±ë³¸ JavaScript
        const majorHierarchy = JSON.parse(document.getElementById('major-hierarchy-data').textContent);
        const gyoyangHierarchy = JSON.parse(document.getElementById('gyoyang-hierarchy-data').textContent);

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.multi-select-dropdown').forEach(setupDropdown);
            
            const collegeDd = document.getElementById('college-dropdown');
            if (collegeDd) collegeDd.addEventListener('change', handleCollegeChange);
            
            const majorDd = document.getElementById('major-dropdown');
            if (majorDd) majorDd.addEventListener('change', handleMajorChange);

            const gyoyangTypeDd = document.getElementById('gyoyang-type-dropdown');
            if (gyoyangTypeDd) gyoyangTypeDd.addEventListener('change', handleGyoyangTypeChange);

            {% if submitted_filters and filtered_recommendations is not None %}
                restoreDropdownState();
            {% endif %}

            const submittedCategories = {{ submitted_filters.subject_category|default:'[]'|safe }};
            if (submittedCategories.length > 0) {
                document.querySelectorAll('input[name="subject_category"]').forEach(cb => { 
                    if (submittedCategories.includes(cb.value)) cb.checked = true; 
                });
            }
            toggleFilters();

            {% if filtered_recommendations is not None %}
                showFilters();
                document.getElementById('filtered-results').scrollIntoView({ behavior: 'smooth', block: 'start' });
            {% endif %}
        });

        function handleCollegeChange() {
            const selected = getSelectedValues('college_name');
            const toShow = new Set();
            selected.forEach(item => {
                Object.keys(majorHierarchy[item] || {}).forEach(sub => toShow.add(sub));
            });
            populateOptions(document.getElementById('major-dropdown'), sortedSet(toShow), 'major_name');
            populateOptions(document.getElementById('major-detail-dropdown'), [], 'major_detail');
            updateAllDisplays();
        }
        
        function handleMajorChange() {
            const selColleges = getSelectedValues('college_name');
            const selMajors = getSelectedValues('major_name');
            const toShow = new Set();
            selColleges.forEach(college => {
                selMajors.forEach(major => {
                    if (majorHierarchy[college] && majorHierarchy[college][major]) {
                        majorHierarchy[college][major].forEach(detail => toShow.add(detail));
                    }
                });
            });
            populateOptions(document.getElementById('major-detail-dropdown'), sortedSet(toShow), 'major_detail');
            updateAllDisplays();
        }

        function handleGyoyangTypeChange() {
            const selected = getSelectedValues('general_type_gyoyang');
            const toShow = new Set();
            selected.forEach(item => {
                (gyoyangHierarchy[item] || []).forEach(sub => toShow.add(sub));
            });
            populateOptions(document.getElementById('gyoyang-subcategory-dropdown'), sortedSet(toShow), 'general_subcategory_gyoyang');
            updateAllDisplays();
        }
        
        function populateOptions(dropdown, items, name) {
            const container = dropdown.querySelector('.checkbox-options');
            container.querySelectorAll('label:not(.select-all)').forEach(el => el.remove());
            items.forEach(item => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = name;
                checkbox.value = item;
                label.appendChild(checkbox);
                label.append(" " + item);
                container.appendChild(label);
            });
            setupDropdown(dropdown);
            updateSelectAllState(container);
        }

        function setupDropdown(dropdown) {
            if (dropdown.dataset.eventsAttached) return;
            dropdown.dataset.eventsAttached = 'true';
            
            const display = dropdown.querySelector('.select-display');
            const optionsContainer = dropdown.querySelector('.checkbox-options');
            
            display.addEventListener('click', e => {
                e.stopPropagation();
                closeAllDropdowns(dropdown);
                optionsContainer.classList.toggle('show');
            });
            
            optionsContainer.addEventListener('change', e => {
                if (e.target.type === 'checkbox') {
                    if (e.target.name === 'select_all') {
                        optionsContainer.querySelectorAll('input[type="checkbox"]:not([name="select_all"])').forEach(cb => cb.checked = e.target.checked);
                    } else {
                        updateSelectAllState(optionsContainer);
                    }
                    updateDropdownDisplay(dropdown);
                    dropdown.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
        }

        function updateSelectAllState(container) {
            const selectAll = container.querySelector('input[name="select_all"]');
            if (!selectAll) return;
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:not([name="select_all"])');
            selectAll.checked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
        }

        window.addEventListener('click', () => closeAllDropdowns());

        function closeAllDropdowns(except = null) {
            document.querySelectorAll('.multi-select-dropdown').forEach(dd => {
                if (dd !== except) {
                    dd.querySelector('.checkbox-options').classList.remove('show');
                }
            });
        }

        function restoreDropdownState() {
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                const name = cb.name;
                const value = cb.value;
                const submitted = {{ submitted_filters|default:'{}'|safe }};
                if (submitted[name] && submitted[name].includes(value)) {
                    cb.checked = true;
                }
            });

            if (getSelectedValues('college_name').length > 0) handleCollegeChange();
            if (getSelectedValues('major_name').length > 0) handleMajorChange();
            if (getSelectedValues('general_type_gyoyang').length > 0) handleGyoyangTypeChange();
            
            // Restore selections for dynamically populated fields
            const submittedMajors = {{ submitted_filters.major_name|default:'[]'|safe }};
            submittedMajors.forEach(major => {
                const cb = document.querySelector(`#major-dropdown input[value="${CSS.escape(major)}"]`);
                if (cb) cb.checked = true;
            });
            
            const submittedDetails = {{ submitted_filters.major_detail|default:'[]'|safe }};
            submittedDetails.forEach(detail => {
                const cb = document.querySelector(`#major-detail-dropdown input[value="${CSS.escape(detail)}"]`);
                if (cb) cb.checked = true;
            });

            const submittedSubcategories = {{ submitted_filters.general_subcategory_gyoyang|default:'[]'|safe }};
            submittedSubcategories.forEach(sub => {
                const cb = document.querySelector(`#gyoyang-subcategory-dropdown input[value="${CSS.escape(sub)}"]`);
                if (cb) cb.checked = true;
            });

            updateAllDisplays();
            document.querySelectorAll('.checkbox-options').forEach(updateSelectAllState);
        }

        function updateDropdownDisplay(dropdown) {
            const count = dropdown.querySelectorAll('input:not([name="select_all"]):checked').length;
            const display = dropdown.querySelector('.select-display');
            let defaultText = '-- ì„ íƒ --';
            if (dropdown.id.includes('major-dropdown')) defaultText = '-- ë‹¨ê³¼ëŒ€í•™ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš” --';
            if (dropdown.id.includes('major-detail')) defaultText = '-- ì „ê³µì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš” --';
            if (dropdown.id.includes('gyoyang-subcategory')) defaultText = '-- êµì–‘ ë¶„ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš” --';
            display.textContent = count > 0 ? `${count}ê°œ ì„ íƒë¨` : defaultText;
        }

        function updateAllDisplays() {
            document.querySelectorAll('.multi-select-dropdown').forEach(updateDropdownDisplay);
        }

        function getSelectedValues(name) {
            return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);
        }
        
        function sortedSet(set) { 
            return Array.from(set).sort((a, b) => a.localeCompare(b, 'ko')); 
        }
        
        function showFilters() {
            document.getElementById('filter-section').style.display = 'block';
            document.getElementById('show-filters-btn').style.display = 'none';
        }

        // [ì¶”ê°€] ë²„íŠ¼í˜• í•„í„°ì˜ 'ì „ì²´' ë²„íŠ¼ì„ ìœ„í•œ í•¨ìˆ˜
        function checkAllOptions(groupName) {
            const checkboxes = document.querySelectorAll(`input[name="${groupName}"]`);
            checkboxes.forEach(cb => {
                cb.checked = true;
            });
        }

        function toggleFilters() {
            const checkboxes = document.querySelectorAll('input[name="subject_category"]');
            const selectedCategories = new Set();
            let isAllSelected = false;
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    if (cb.value === 'ì „ì²´') isAllSelected = true;
                    else selectedCategories.add(cb.value);
                }
            });

            const majorFilters = document.getElementById('major-filters');
            const gyoyangFilters = document.getElementById('gyoyang-filters');
            const etcFilters = document.getElementById('etc-filters');

            if (isAllSelected) {
                majorFilters.style.display = 'block';
                gyoyangFilters.style.display = 'block';
                etcFilters.style.display = 'block';
                checkboxes.forEach(cb => { if (cb.value !== 'ì „ì²´') cb.checked = false; });
            } else {
                document.querySelector('input[name="subject_category"][value="ì „ì²´"]').checked = false;
                majorFilters.style.display = selectedCategories.has('ì „ê³µ') ? 'block' : 'none';
                gyoyangFilters.style.display = selectedCategories.has('êµì–‘') ? 'block' : 'none';
                etcFilters.style.display = selectedCategories.has('ê¸°íƒ€') ? 'block' : 'none';
            }
        }

        window.addEventListener('DOMContentLoaded', function() {
            const submittedCategories = {{ submitted_filters.subject_category|default:'[]'|safe }};
            if (submittedCategories.length > 0) {
                const checkboxes = document.querySelectorAll('input[name="subject_category"]');
                checkboxes.forEach(cb => { if (submittedCategories.includes(cb.value)) cb.checked = true; });
            }
            toggleFilters();

            {% if filtered_recommendations is not None %}
                showFilters();
                const resultsDiv = document.getElementById('filtered-results');
                if (resultsDiv) {
                    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            {% endif %}
        });
    </script>
</body>
</html>